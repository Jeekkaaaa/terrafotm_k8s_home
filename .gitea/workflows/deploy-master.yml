name: Full K8s Deployment with Template
on: [push]

jobs:
  deploy:
    runs-on: [ubuntu-22.04]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate SSH Key
        run: |
          mkdir -p /root/.ssh
          if [ ! -f /root/.ssh/id_ed25519 ]; then
            ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N "" -q
          fi
          echo "=== SSH Public Key ==="
          cat /root/.ssh/id_ed25519.pub

      - name: Check IP Range Availability
        run: |
          echo "=== Проверка диапазона IP адресов ==="
          
          if [ ! -f config.auto.tfvars ]; then
            echo "❌ Файл config.auto.tfvars не найден!"
            exit 1
          fi
          
          SUBNET=$(grep 'subnet' config.auto.tfvars | sed -n 's/.*"\([^"]*\)".*/\1/p')
          STATIC_BASE=$(grep 'static_ip_base' config.auto.tfvars | awk '{print $3}')
          MASTERS_COUNT=$(grep -A2 'masters_count' config.auto.tfvars | grep -o '[0-9]\+' | head -1)
          WORKERS_COUNT=$(grep -A2 'workers_count' config.auto.tfvars | grep -o '[0-9]\+' | head -1')
          
          echo "Сеть: $SUBNET"
          echo "Базовый IP: $STATIC_BASE"
          echo "Мастер-нод: $MASTERS_COUNT"
          echo "Воркер-нод: $WORKERS_COUNT"
          
          if [ -z "$SUBNET" ] || [ -z "$STATIC_BASE" ]; then
            echo "❌ Не удалось прочитать настройки"
            exit 1
          fi
          
          NETWORK_PREFIX=$(echo "$SUBNET" | cut -d'/' -f1 | awk -F. '{print $1"."$2"."$3}')
          TOTAL_NODES=$((MASTERS_COUNT + WORKERS_COUNT))
          
          echo "=== Проверка $TOTAL_NODES IP адресов ==="
          
          ALL_FREE=true
          for i in $(seq 0 $((TOTAL_NODES - 1))); do
            IP_INDEX=$((STATIC_BASE + i))
            CHECK_IP="${NETWORK_PREFIX}.${IP_INDEX}"
            
            echo -n "  $CHECK_IP ... "
            if ping -c 1 -W 1 "$CHECK_IP" >/dev/null 2>&1; then
              echo "ЗАНЯТ ❌"
              ALL_FREE=false
            else
              echo "свободен ✅"
            fi
          done
          
          if [ "$ALL_FREE" = false ]; then
            echo "❌ Некоторые IP адреса уже заняты!"
            echo "Измените static_ip_base в config.auto.tfvars"
            exit 1
          else
            echo "✅ Все IP адреса свободны"
          fi

      - name: Clean Terraform Cache
        run: |
          echo "=== Очистка Terraform кэша ==="
          rm -rf .terraform .terraform.lock.hcl 2>/dev/null || true
          echo "Кэш очищен"

      - name: Show Configuration
        run: |
          echo "=== Config.auto.tfvars ==="
          cat config.auto.tfvars | head -30
          echo ""
          echo "=== Variables.tf ==="
          cat variables.tf | grep "variable \"" | head -20

      - name: Terraform Init
        run: terraform init
        env:
          TF_VAR_pm_api_url: ${{ secrets.PM_API_URL }}
          TF_VAR_pm_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
          TF_VAR_pm_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -input=false
        env:
          TF_VAR_pm_api_url: ${{ secrets.PM_API_URL }}
          TF_VAR_pm_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
          TF_VAR_pm_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}

      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false
        env:
          TF_VAR_pm_api_url: ${{ secrets.PM_API_URL }}
          TF_VAR_pm_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
          TF_VAR_pm_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}
