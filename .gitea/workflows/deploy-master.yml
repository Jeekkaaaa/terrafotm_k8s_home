name: Deploy K8s Cluster
on: [push]

jobs:
  deploy:
    runs-on: [ubuntu-22.04]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read network config
        run: |
          echo "=== Читаем конфигурацию сети ==="
          CONFIG="config.auto.tfvars"
          
          SUBNET_LINE=$(grep 'subnet' "$CONFIG")
          SUBNET=$(echo "$SUBNET_LINE" | grep -o '"[^"]*"' | head -1 | tr -d '"')
          
          if [ -z "$SUBNET" ]; then
            echo "❌ Не найден subnet в config"
            exit 1
          fi
          
          NETWORK_PREFIX=$(echo "$SUBNET" | cut -d'/' -f1 | cut -d. -f1-3)
          echo "Network prefix: $NETWORK_PREFIX"
          echo "NETWORK_PREFIX=$NETWORK_PREFIX" >> $GITHUB_ENV

      # УДАЛЕН блок Generate SSH Key - используем ключ из секретов

      - name: Auto-find Free IP Range
        run: |
          echo "=== Ищем свободные IP в $NETWORK_PREFIX.XXX ==="
          
          NEEDED_IPS=3
          
          for start in $(seq 100 240); do
            FREE=true
            for i in $(seq 0 $((NEEDED_IPS - 1))); do
              IP="$NETWORK_PREFIX.$((start + i))"
              if ping -c 1 -W 1 "$IP" >/dev/null 2>&1; then
                FREE=false
                break
              fi
            done
            
            if [ "$FREE" = true ]; then
              echo "✅ Найден свободный диапазон с $start"
              echo "STATIC_IP_BASE=$start" >> $GITHUB_ENV
              exit 0
            fi
          done
          
          echo "❌ Не найдено $NEEDED_IPS свободных IP подряд"
          exit 1

      - name: Update main config file
        run: |
          echo "=== Обновляем основной config.auto.tfvars ==="
          
          # Обновляем ТОЛЬКО static_ip_base (ssh_public_key удаляем из файла)
          sed -i "s/static_ip_base = .*/static_ip_base = $STATIC_IP_BASE/" config.auto.tfvars
          
          echo "✅ Обновлено: static_ip_base = $STATIC_IP_BASE"
          echo "ℹ️  SSH ключ передается через TF_VAR_ssh_public_key (из секретов)"

      - name: Create Template
        run: |
          echo "=== Создаем шаблон Ubuntu ==="
          cd template
          terraform init
          terraform apply -auto-approve -input=false -var-file="../config.auto.tfvars"
          cd ..
          sleep 15
        env:
          TF_VAR_pm_api_url: ${{ secrets.PM_API_URL }}
          TF_VAR_pm_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
          TF_VAR_pm_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}
          # SSH доступ к Proxmox
          TF_VAR_proxmox_ssh_username: ${{ secrets.PROXMOX_SSH_USERNAME }}
          TF_VAR_proxmox_ssh_password: ${{ secrets.PROXMOX_SSH_PASSWORD }}
          # SSH ключ для ВМ из секретов
          TF_VAR_ssh_public_key: ${{ secrets.PROXMOX_SSH_PUBKEY }}

      - name: Deploy Master and Workers
        run: |
          echo "=== Создаем Master и Worker ноды ==="
          
          for dir in master worker; do
            echo "--- $dir ---"
            cd "$dir"
            terraform init
            terraform apply -auto-approve -input=false -var-file="../config.auto.tfvars"
            cd ..
          done
        env:
          TF_VAR_pm_api_url: ${{ secrets.PM_API_URL }}
          TF_VAR_pm_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
          TF_VAR_pm_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}
          # SSH доступ к Proxmox
          TF_VAR_proxmox_ssh_username: ${{ secrets.PROXMOX_SSH_USERNAME }}
          TF_VAR_proxmox_ssh_password: ${{ secrets.PROXMOX_SSH_PASSWORD }}
          # SSH ключ для ВМ из секретов
          TF_VAR_ssh_public_key: ${{ secrets.PROXMOX_SSH_PUBKEY }}
